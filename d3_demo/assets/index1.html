<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>D3</title>
    <!-- <link href="css/spinner.css" rel="stylesheet">-->
  </head>
  <body>
      <script type="text/javascript">"/js/d3.min.js"</script>
      <script src="https://d3js.org/d3.v4.min.js"></script>
      <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
        <script>
                function DD3Net(protocol, config) {
                    this.protocol = protocol;
                    this.config = config || {};
                    switch (protocol) {
                        case 'peerjs':
                            this.id = this.config.id || peerObj.id || '';
                            //this.id = peerObj.id;
                            this.peers = peerObj.peers;
                            this.connections = peerObj.connections;
                            this.buffers = peerObj.buffers;

                            this.peerOption = {
                                //There is no response from the peerJS server if adding the whole arguments below. Maybe we should check the peerjs set-up
                                //key: this.config.key || '',
                                host: this.config.host || "146.169.32.109",
                                port: this.config.port || 55555,
                                //path: this.config.path || '/',
                                //secure: this.config.secure || false,
                                //config: this.config.config || { 'iceServers': [{ 'url': 'stun:stun.l.google.com:19302' }] },
                                //debug: this.config.debug || 0
                            };
                            this.peer = new Peer(this.id, this.peerOption);
                            break;
                        case 'socketio':

                            break;

                        case 'signalr':
                            this.dd3Server = $.connection.dD3AppHub;
                            break;

                        default:
                            throw new Error('No specific protocal name in DD3Net parameters');
                    }
                }



                DD3Net.prototype.init = function(conn, r, c){
                    if ('peerjs' === this.protocol) {
                        return peerObj.init(conn, r, c);
                    }
                    else if ('signalr' === this.protocol) {
                    }
                }

                DD3Net.prototype.connect = function (r, c) {
                    if ('peerjs' === this.protocol) {
                        return peerObj.connect(r, c);
                    }
                    else if ('signalr' === this.protocol) {
                    }
            
                }


                DD3Net.prototype.receive = function(data){
                    if ('peerjs' === this.protocol) {
                        return peerObj.receive(data);
                    }
                    else if ('signalr' === this.protocol) {
                    }
                }

                DD3Net.prototype.sendTo = function(r, c, data, buffer){
                    if ('peerjs' === this.protocol) {
                        return peerObj.sendTo(r, c, data, buffer);
                    }
                    else if ('signalr' === this.protocol) {
                    }
                }

                DD3Net.prototype.flush = function(r,c){
                    if ('peerjs' === this.protocol) {
                        return peerObj.flush(r,c);
                    }
                    else if ('signalr' === this.protocol) {
                    }
                }


                var peerObj = {
                    id: null,
                    peers: [],
                    connections: [],
                    buffers: [],

                    init: function(conn, r, c){
                        //utils.log("Connection established with Peer (" + [r, c] + "): " + conn.peer, 0);
                        //conn.on("data", this.receive);
                        console.log(DD3Net);
                        console.log('peerjs init');
                        this.flush(r, c);
                    },

                    connect: function (r, c){
                        r = +r;
                        c = +c;

                        // Try to find peer with r and c as row and column - use Array.some to stop when found
                        // if the row, column pair is not the same as those of the connections, return false

                        return this.peers.some(function (p) {
                            if (+p.row !== r || +p.col !== c)
                                return false;

                            var conn = peer.peer.connect(p.peerId, { reliable: true, metadata: { initiator: [browser.row, browser.column] } });
                            //conn.on("open", dd3Net.init.bind(null, conn, r, c));
                            //dd3Net.connections[r][c] = conn;
                            this.buffers[r][c] = [];
                            console.log(dd3Net.buffers);
                            return true;
                        });
                    },

                    receive: function (data){
                        console.log('peerReceive');
                        if (data instanceof Array) {
                            data.forEach(peer.receive);
                            return;
                        }

                        switch (data.type) {
                            case 'shape':
                                utils.log("Receiving a new shape...");
                                _dd3_shapeHandler(data);
                                break;

                            case 'property':
                                utils.log("Receiving a property [" + data.function + (data.property ? (":" + data.property) : "") + "] update...");
                                _dd3_propertyHandler(data);
                                break;

                            case 'remove':
                                utils.log("Receiving an exiting shape...");
                                _dd3_removeHandler(data);
                                break;

                            case 'transition':
                                utils.log("Receiving a transition... ");
                                _dd3_transitionHandler(data);
                                break;

                            case 'endTransition':
                                utils.log("Receiving a end transition event...");
                                _dd3_endTransitionHandler(data);
                                break;

                            default:
                                utils.log("Receiving an unsupported data : Aborting !", 2);
                                utils.log(data, 2);
                                return false;
                        }
                    },

                    sendTo: function (r, c, data, buffer) {
                        if (typeof peer.connections[r][c] === "undefined" && !peer.connect(r, c)) {
                            // If there is no such peer
                            return false;
                        }

                        // If connection is being established or we asked to buffer, we buffer - else we send
                        if (!peer.connections[r][c].open || buffer) {
                            peer.buffers[r][c].push(data);
                        } else {
                            //BAI:.send is the peer api
                            peer.connections[r][c].send(data);
                        }

                        return true;
                    },

                    flush: function (r,c){
                        //console.log('peerFlush');
                        /*
                        var buff = peer.buffers[r][c],
                            conn = peer.connections[r][c];
                        if (buff && buff.length > 0 && conn && conn.open) {
                            conn.send(buff);
                            peer.buffers[r][c] = [];
                            return true;
                        }
                        return false;
                        */
                    }
                }
          

                var dd3PeerNet = new DD3Net ('peerjs');
                dd3PeerNet.init();
<<<<<<< HEAD
       
             
                var a = {
                    b:dd3PeerNet
                }
                console.log(a.b);
                a.b.init();
                asdadasdasdas
                //var signalrNet = new DD3Net ('signalr');
                //signalrNet.synchronize();
=======
>>>>>>> parent of 912d5d0... copy to .net
        </script>

       
  </body>
</html>